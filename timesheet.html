<!DOCTYPE html>
<html>
  <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>
    <script>
        // global variable to hold the categories
        var categoriesArray = [];

        function buildPrimaryCategories(selectedCategoryID) {
            // from the Json, build the UI
            // note that the categoriesArray is a global variable
            var pc = document.getElementById("primaryLogTypeRadio")
            pc.replaceChildren();
            for (let i = 0; i < categoriesArray.length; i++) {
                var newDiv = document.createElement("div");
                newDiv.setAttribute('class','form-check form-check-inline')
                radioInput = document.createElement('input');
                radioInput.setAttribute('class', 'form-check-input')
                radioInput.setAttribute('type', 'radio');
                radioInput.setAttribute('name','primaryLogType');
                radioInput.setAttribute('value', categoriesArray[i].ID.toString())
                radioInput.setAttribute('id', 'primaryLogTypeRadio'+categoriesArray[i].ID.toString())
                if (categoriesArray[i].ID == selectedCategoryID) {
                    radioInput.checked = true;
                }
                // not sure this is the best way to do this...
                radioInput.setAttribute('onchange', 'buildSecondaryCategories('+categoriesArray[i].ID.toString()+', 0)')
                newDiv.appendChild(radioInput)
                radioLabel = document.createElement("label")
                radioLabel.setAttribute('class', 'form-check-label')
                radioLabel.setAttribute('for','primaryLogTypeRadio'+categoriesArray[i].ID.toString())
                radioLabel.innerHTML = categoriesArray[i].Name
                newDiv.appendChild(radioLabel)
                pc.appendChild(newDiv)
            }
        }

        function buildSecondaryCategories(selectedPrimaryID, selectedSecondaryID) {
            // from the Json, build the UI
            // note that the categoriesArray is a global variable
            var pc = document.getElementById("secondaryLogTypeRadio")
            pc.replaceChildren();
            for (let i = 0; i < categoriesArray.length; i++) {
                if (categoriesArray[i].ID == selectedPrimaryID) {
                    document.getElementById("bgcolour").value = categoriesArray[i].Colour
                    for (let j = 0; j < categoriesArray[i].Secondary.length; j++) {
                        var newDiv = document.createElement("div");
                        newDiv.setAttribute('class','form-check form-check-inline')
                        radioInput = document.createElement('input');
                        radioInput.setAttribute('class', 'form-check-input')
                        radioInput.setAttribute('type', 'radio');
                        radioInput.setAttribute('name','secondaryLogType');
                        radioInput.setAttribute('value', categoriesArray[i].Secondary[j].ID.toString())
                        radioInput.setAttribute('id', 'secondaryLogTypeRadio'+categoriesArray[i].Secondary[j].ID.toString())
                        if (categoriesArray[i].Secondary[j].ID == selectedSecondaryID) {
                            radioInput.checked = true;
                        }
                        newDiv.appendChild(radioInput)
                        radioLabel = document.createElement("label")
                        radioLabel.setAttribute('class', 'form-check-label')
                        radioLabel.setAttribute('for','secondaryLogTypeRadio'+categoriesArray[i].Secondary[j].ID.toString())
                        radioLabel.innerHTML = categoriesArray[i].Secondary[j].Name
                        newDiv.appendChild(radioLabel)
                        pc.appendChild(newDiv)
                    }
                    break
                }
            }
        }

        //Handle the save button being pressed
        async function saveEventData() {
            const form = document.getElementById("eventForm")
            //get the form data
            const formdata = serializeForm(form)

            // perform validation here
            // check that fields are filled in
            if (true) {
            
                //write/update the database
                const data = new URLSearchParams();
                for (const pair of new FormData(form)) {
                    data.append(pair[0], pair[1]);
                }
                const responce = await fetch("/saveEventDatatoDB", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: data
                })
                console.log("Save to database Ajax ")
                var neweventid = await responce.text()
                console.log("New event id: " + neweventid)
                // write the event to screen
                // need to move this to after the post to db so can get the ID
                var thenewevent = myTimeCalendar.addEvent({
                    id: neweventid,
                    title: formdata.description + " (" + formdata.customer + ")",
                    start: formdata.start,
                    end: formdata.end,
                    borderColor: '#' + formdata.bgcolour,
                    backgroundColor: "#" + LightenDarkenColor(formdata.bgcolour, 30)
                })

                // close the modal
                var myModalEl = document.getElementById("exampleModal")
                var modal = bootstrap.Modal.getInstance(myModalEl)
                modal.hide();
            }
        }

        var serializeForm = function (form) {
	        var obj = {};
	        var formData = new FormData(form);
	        for (var key of formData.keys()) {
		        obj[key] = formData.get(key);
	        }
	        return obj;
        };

        // show the modal dialog
        async function showModelDialog(arg) {
            var myModal = new bootstrap.Modal(document.getElementById("exampleModal"), {});
            // set the start and end hidden fields
            document.getElementById("start").value = arg.start.toISOString()
            document.getElementById("end").value = arg.end.toISOString()
            // get category data
            //https://www.freecodecamp.org/news/how-to-fetch-data-from-an-api-using-the-fetch-api-in-javascript/
            const response = await fetch('/getCategoriesfromDB')
            categoriesArray = await response.json()

            // Build the radio buttons
            buildPrimaryCategories(1)
            buildSecondaryCategories(1, 0)
            // set the modal data
            myModal.show();
        }
        
        // function to handle user changing the description
        function userChangedDesc() {
            // need to update the form fields to the ones previously used for that description
            console.log("Need to update screen")
        }

        // change the colours
        function LightenDarkenColor(col, amt) {
            col = parseInt(col, 16);
            return (((col & 0x0000FF) + amt) | ((((col >> 8) & 0x00FF) + amt) << 8) | (((col >> 16) + amt) << 16)).toString(16);
        }

    </script>
    <script>
        // global calendar reference
        var myTimeCalendar;
        // Full Calendar Stuff
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar')
            myTimeCalendar = new FullCalendar.Calendar(calendarEl, {
                firstDay: 1,
                initialView: 'timeGridWeek',
                slotDuration: '00:15',
                slotLabelInterval: '01:00',
                themeSystem: 'bootstrap5',
                selectable: true,
                unselectAuto: false,
                selectMirror: true,
                select: function(arg) {
                    // User has created a date range.
                    // Need to add to the events and to the database
                    // https://developer.mozilla.org/en-US/docs/Web/HTML/Element/dialog
                    // https://stackoverflow.com/questions/41570878/jquery-dialog-popup-returns-json-to-new-page-instead-of-current-page
                    // this needs to be a proper model dialog with the
                    // data that I want to store
                    // var myModal = new bootstrap.Modal(document.getElementById("exampleModal"), {});
                    // // set the modal data
                    // setModelData(arg)
                    // myModal.show();
                    showModelDialog(arg)

                    // var title = prompt('Event Title:');
                    // if (title) {
                    //     var thenewevent = calendar.addEvent({
                    //         title: title,
                    //         start: arg.start,
                    //         end: arg.end,
                    //         allDay: arg.allDay,
                    //         backgroundColor: 'red'
                    //     })
                    //     // this is where it needs to ajax the backend DB to store
                    //     console.log("Save to database Ajax " + arg.start.toISOString() + " to " + arg.end.toISOString())
                    //     const xhttp = new XMLHttpRequest();
                    //     xhttp.open("POST", "/saveEventDatatoDB", true);
                    //     xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    //     xhttp.send("start="+arg.start.toISOString()+"&end="+arg.end.toISOString());
                    // }
                    myTimeCalendar.unselect()
                },
                eventClick: function(arg) {
                    // User has clicked on an existing item. Need to offer ability to
                    // edit or remove.
                    // Need to add/remove from the database
                    if (confirm('Are you sure you want to delete this event?')) {
                        arg.event.remove()
                    }
                },
                datesSet: function(arg) {
                    console.log(arg.start.toISOString()+ " to " + arg.end.toISOString())
                    // this should load the data from the database for the period
                    const xhttp = new XMLHttpRequest();
                    xhttp.open("GET", "/getEventDatafromDB?start="+arg.start.toISOString()+"&end="+arg.end.toISOString(), true);
                    xhttp.send("test");
                },
                editable: true,
                // need to load the calendar events from the database into an events array here
                // to match the physical timesheet, should also have some events with display: background
                // to have the gray boxes on the timesheet.
                // events: [
                //     {
                //         start: '2024-01-18T00:00:00',
                //         end: '2024-01-18T08:30:00',
                //         backgroundColor: '#C9C9C9',
                //         display: 'background'
                //     },
                //     {
                //         start: '2024-01-18T12:00:00',
                //         end: '2024-01-18T13:00:00',
                //         backgroundColor: '#C9C9C9',
                //         display: 'background'
                //     },
                //     {
                //         start: '2024-01-18T17:00:00',
                //         end: '2024-01-18T23:59:59',
                //         backgroundColor: '#C9C9C9',
                //         display: 'background'
                //     },
                // ] 
            })

            myTimeCalendar.render()
        })

    </script>
  </head>
  <body>
    <div id='calendar'></div>

    <!-- Modal Dialog-->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">Add Time Log</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="container px-5 my-5">
                    <form id="eventForm">
                        <!-- Hidden data fields for passing stuff -->
                        <input name="start" id="start" type="hidden" />
                        <input name="end" id="end" type="hidden" />
                        <input name="bgcolour" id="bgcolour" type="hidden" />
                        
                        <div class="form-floating mb-3">
                            <input name="description" onchange="userChangedDesc();" list="descriptionOptions" class="form-control" id="description" type="text" placeholder="Description" />
                            <label for="description">Description</label>
                            <datalist id="descriptionOptions">
                                <!-- Populate by Javascript -->
                                <option value="San Francisco">
                                <option value="New York">
                                <option value="Seattle">
                                <option value="Los Angeles">
                                <option value="Chicago">
                            </datalist>
                        </div>
                        <div class="form-floating mb-3">
                            <input name="customer" list="customerOptions" class="form-control" id="customer" type="text" placeholder="Customer" />
                            <label for="customer">Customer</label>
                            <datalist id="customerOptions">
                                <!-- Populate by Javascript -->
                                <option value="San Francisco">
                                <option value="New York">
                                <option value="Seattle">
                                <option value="Los Angeles">
                                <option value="Chicago">
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-block">Primary Log Type</label>
                            <div id="primaryLogTypeRadio">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionA" type="radio" name="primaryLogType" value="optionA" />
                                    <label class="form-check-label" for="optionA">option A</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionB" type="radio" name="primaryLogType" value="optionB" />
                                    <label class="form-check-label" for="optionB">option B</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionC" type="radio" name="primaryLogType" value="optionC" />
                                    <label class="form-check-label" for="optionC">option C</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-block">Secondary Log Type</label>
                            <div id="secondaryLogTypeRadio">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionA" type="radio" name="secondaryLogType" data-sb-validations="" />
                                    <label class="form-check-label" for="optionA">option A</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionB" type="radio" name="secondaryLogType" data-sb-validations="" />
                                    <label class="form-check-label" for="optionB">option B</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionC" type="radio" name="secondaryLogType" data-sb-validations="" />
                                    <label class="form-check-label" for="optionC">option C</label>
                                </div>
                            </div>
                        </div>
                        
                    </form>
                </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button onclick="saveEventData()" id="saveEventButton" type="button" class="btn btn-primary">Save changes</button>
            </div>
          </div>
        </div>
      </div>
      <!-- End Dialog -->

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>