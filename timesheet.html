<!DOCTYPE html>
<html>
  <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>
    <script src='helperfunctions.js'></script>
    <script>
        // global variable to hold the categories
        var categoriesArray = [];

        function buildPrimaryCategories(selectedCategoryID) {
            // from the Json, build the UI
            // note that the categoriesArray is a global variable
            var pc = document.getElementById("primaryLogTypeRadio")
            pc.replaceChildren();
            for (let i = 0; i < categoriesArray.length; i++) {
                var newDiv = document.createElement("div");
                newDiv.setAttribute('class','form-check form-check-inline')
                radioInput = document.createElement('input');
                radioInput.setAttribute('class', 'form-check-input')
                radioInput.setAttribute('type', 'radio');
                radioInput.setAttribute('name','primaryLogType');
                radioInput.setAttribute('value', categoriesArray[i].ID.toString())
                radioInput.setAttribute('id', 'primaryLogTypeRadio'+categoriesArray[i].ID.toString())
                if (categoriesArray[i].ID == selectedCategoryID) {
                    radioInput.checked = true;
                }
                // not sure this is the best way to do this...
                radioInput.setAttribute('onchange', 'buildSecondaryCategories('+categoriesArray[i].ID.toString()+', 0)')
                newDiv.appendChild(radioInput)
                radioLabel = document.createElement("label")
                radioLabel.setAttribute('class', 'form-check-label')
                radioLabel.setAttribute('for','primaryLogTypeRadio'+categoriesArray[i].ID.toString())
                radioLabel.innerHTML = categoriesArray[i].Name
                newDiv.appendChild(radioLabel)
                pc.appendChild(newDiv)
            }
        }

        function buildSecondaryCategories(selectedPrimaryID, selectedSecondaryID) {
            // from the Json, build the UI
            // note that the categoriesArray is a global variable
            var pc = document.getElementById("secondaryLogTypeRadio")
            pc.replaceChildren();
            for (let i = 0; i < categoriesArray.length; i++) {
                if (categoriesArray[i].ID == selectedPrimaryID) {
                    document.getElementById("bgcolour").value = categoriesArray[i].Colour
                    for (let j = 0; j < categoriesArray[i].Secondary.length; j++) {
                        var newDiv = document.createElement("div");
                        newDiv.setAttribute('class','form-check form-check-inline')
                        radioInput = document.createElement('input');
                        radioInput.setAttribute('class', 'form-check-input')
                        radioInput.setAttribute('type', 'radio');
                        radioInput.setAttribute('name','secondaryLogType');
                        radioInput.setAttribute('value', categoriesArray[i].Secondary[j].ID.toString())
                        radioInput.setAttribute('id', 'secondaryLogTypeRadio'+categoriesArray[i].Secondary[j].ID.toString())
                        if (categoriesArray[i].Secondary[j].ID == selectedSecondaryID) {
                            radioInput.checked = true;
                        }
                        newDiv.appendChild(radioInput)
                        radioLabel = document.createElement("label")
                        radioLabel.setAttribute('class', 'form-check-label')
                        radioLabel.setAttribute('for','secondaryLogTypeRadio'+categoriesArray[i].Secondary[j].ID.toString())
                        radioLabel.innerHTML = categoriesArray[i].Secondary[j].Name
                        newDiv.appendChild(radioLabel)
                        pc.appendChild(newDiv)
                    }
                    break
                }
            }
        }

        //Handle the save button being pressed
        async function saveEventData() {
            const form = document.getElementById("eventForm")
            //get the form data
            const formdata = serializeForm(form)

            // perform validation here
            // check that fields are filled in
            console.log(formdata)
            if (validateFormData(formdata)) {
            
                //write/update the database
                const data = new URLSearchParams();
                for (const pair of new FormData(form)) {
                    data.append(pair[0], pair[1]);
                }
                const responce = await fetch("/saveEventDatatoDB", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: data
                })
                console.log("Save to database Ajax ")
                var neweventid = await responce.text()
                console.log("New event id: " + neweventid)
                // write the event to screen
                // need to move this to after the post to db so can get the ID
                var thenewevent = myTimeCalendar.addEvent({
                    id: neweventid,
                    title: formdata.description + " (" + formdata.customer + ")",
                    start: formdata.start,
                    end: formdata.end,
                    borderColor: '#' + formdata.bgcolour,
                    backgroundColor: "#" + LightenDarkenColor(formdata.bgcolour, 30)
                })

                // close the modal
                var myModalEl = document.getElementById("exampleModal")
                var modal = bootstrap.Modal.getInstance(myModalEl)
                modal.hide();
            } else {
                // TODO - display a missing fields warning
            }
        }

        var serializeForm = function (form) {
	        var obj = {};
	        var formData = new FormData(form);
	        for (var key of formData.keys()) {
		        obj[key] = formData.get(key);
	        }
	        return obj;
        };

        // show the modal dialog
        async function showModelDialog(arg) {
            var myModal = new bootstrap.Modal(document.getElementById("exampleModal"), {});
            // need to check the arg to figure out if we are loading an existing dialog
            // or building a new one.

            // set the start and end hidden fields
            document.getElementById("start").value = arg.start.toISOString()
            document.getElementById("end").value = arg.end.toISOString()
            // get category data
            //https://www.freecodecamp.org/news/how-to-fetch-data-from-an-api-using-the-fetch-api-in-javascript/
            const response = await fetch('/getCategoriesfromDB')
            categoriesArray = await response.json()

            // Build the radio buttons
            buildPrimaryCategories(1)
            buildSecondaryCategories(1, 1)
            // set the modal data
            myModal.show();
        }
        
        async function updateExistingEvent(event) {
            //user has drag an event. Need to update the times in database
            //write/update the database
            const data = new URLSearchParams();
            data.append("id", event.id);
            data.append("start", event.start.toISOString());
            data.append("end", event.end.toISOString());
            const responce = await fetch("/updateEventDatatoDB", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: data
            })
        }

        // function to handle user changing the description
        function userChangedDesc() {
            // need to update the form fields to the ones previously used for that description
            console.log("Need to update screen")
        }

        // function to get the event data from the database
        async function populateCalendar(start, end) {
            //write/update the database
            const data = new URLSearchParams();
            data.append("start", start);
            data.append("end", end);
            try {
                const responce = await fetch("/getEventDatafromDB?"+data.toString())
                const events =  await responce.json()
                console.log(events)
                if (events != null) {
                    events.forEach(event => {
                        myTimeCalendar.addEvent({
                            title: event.Description + " (" + event.Customer + ")",
                            start: event.Start,
                            end: event.End,
                            borderColor: '#' + event.Colour,
                            backgroundColor: "#" + LightenDarkenColor(event.Colour, 30)
                        }
                        )
                    });
                }
            } catch (error) {
                console.log(error)
            }
                    
        }

    </script>
    <script>
        // global calendar reference
        var myTimeCalendar;
        // Full Calendar Stuff
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar')
            myTimeCalendar = new FullCalendar.Calendar(calendarEl, {
                firstDay: 1,
                initialView: 'timeGridWeek',
                slotDuration: '00:15',
                slotLabelInterval: '01:00',
                themeSystem: 'bootstrap5',
                selectable: true,
                unselectAuto: false,
                selectMirror: true,
                select: function(arg) {
                    showModelDialog(arg)
                    myTimeCalendar.unselect()
                },
                eventClick: function(arg) {
                    // User has clicked on an existing item. Need to offer ability to
                    // edit or remove.
                    // Need to add/remove from the database
                    if (confirm('Are you sure you want to delete this event?')) {
                        arg.event.remove()
                    }
                },
                eventChange: function(arg) {
                    console.log("eventChange")
                    updateExistingEvent(arg.event)
                },
                datesSet: function(arg) {
                    console.log(arg.start.toISOString()+ " to " + arg.end.toISOString())
                    // this should load the data from the database for the period
                    populateCalendar(arg.start.toISOString(), arg.end.toISOString())
                },
                editable: true,
            })

            myTimeCalendar.render()
        })

    </script>
  </head>
  <body>
    <div id='calendar'></div>

    <!-- Modal Dialog-->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">Add Time Log</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="container px-5 my-5">
                    <form id="eventForm">
                        <!-- Hidden data fields for passing stuff -->
                        <input name="start" id="start" type="hidden" />
                        <input name="end" id="end" type="hidden" />
                        <input name="bgcolour" id="bgcolour" type="hidden" />
                        
                        <div class="form-floating mb-3">
                            <input name="description" onchange="userChangedDesc();" list="descriptionOptions" class="form-control" id="description" type="text" placeholder="Description" />
                            <label for="description">Description</label>
                            <datalist id="descriptionOptions">
                                <!-- Populate by Javascript -->
                                <option value="San Francisco">
                                <option value="New York">
                                <option value="Seattle">
                                <option value="Los Angeles">
                                <option value="Chicago">
                            </datalist>
                        </div>
                        <div class="form-floating mb-3">
                            <input name="customer" list="customerOptions" class="form-control" id="customer" type="text" placeholder="Customer" />
                            <label for="customer">Customer</label>
                            <datalist id="customerOptions">
                                <!-- Populate by Javascript -->
                                <option value="San Francisco">
                                <option value="New York">
                                <option value="Seattle">
                                <option value="Los Angeles">
                                <option value="Chicago">
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-block">Primary Log Type</label>
                            <div id="primaryLogTypeRadio">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionA" type="radio" name="primaryLogType" value="optionA" />
                                    <label class="form-check-label" for="optionA">option A</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionB" type="radio" name="primaryLogType" value="optionB" />
                                    <label class="form-check-label" for="optionB">option B</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionC" type="radio" name="primaryLogType" value="optionC" />
                                    <label class="form-check-label" for="optionC">option C</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-block">Secondary Log Type</label>
                            <div id="secondaryLogTypeRadio">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionA" type="radio" name="secondaryLogType" data-sb-validations="" />
                                    <label class="form-check-label" for="optionA">option A</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionB" type="radio" name="secondaryLogType" data-sb-validations="" />
                                    <label class="form-check-label" for="optionB">option B</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="optionC" type="radio" name="secondaryLogType" data-sb-validations="" />
                                    <label class="form-check-label" for="optionC">option C</label>
                                </div>
                            </div>
                        </div>
                        
                    </form>
                </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button onclick="saveEventData()" id="saveEventButton" type="button" class="btn btn-primary">Save changes</button>
            </div>
          </div>
        </div>
      </div>
      <!-- End Dialog -->

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>