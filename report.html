<!DOCTYPE html>
<html>
  <head>
    <style>
        body {
            background-color: #FF3CAC;
            background-image: linear-gradient(225deg, #FF3CAC 0%, #784BA0 50%, #2B86C5 100%);
        }

        #reportholder {
            background-color: white;
            margin: 40px;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0px 0px 25px 0px rgb(0, 0, 0);
            height: 100%;
        }

    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>
    <script src='helperfunctions.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
        
</head>
    <body onload="getPrimaryData()"></body>
        <div id='reportholder'>
            <canvas id="myChart" width="400" height="400"></canvas>
        </div>
        <script>
            function toRelative(numbers) {
                //const largestNumber = Math.max(...numbers)
                const total = numbers.reduce((a,b)=>a+b)
                return numbers.map(number => (number / total)*100)
            }

            donutprimarynames = []
            donutprimarycolours = []
            donutprimaryvalues = []
            donutsecondarynames = []
            donutsecondarycolours = []
            donutsecondaryvalues = []
            async function getPrimaryData() {
                const data = new URLSearchParams(window.location.search);
                try {
                    const responce = await fetch("/reportPrimaryfromDB?"+data.toString())
                    donutdata = await responce.json()
                    let currentprimary = ""
                    for (i=0; i< donutdata.length; i++) {
                        // there must be a better way to do this....
                        if (donutdata[i].Primaryname.toString() != currentprimary.toString()) {
                            // new primary category
                            console.log(donutdata[i].Primaryname.toString() + " >>> " + currentprimary +".")
                            currentprimary = donutdata[i].Primaryname.toString()
                            donutprimarynames.push(currentprimary)
                            donutprimarycolours.push("#" + donutdata[i].Colour)
                            donutprimaryvalues.push(donutdata[i].Duration)
                        } else {
                            donutprimaryvalues[donutprimaryvalues.length - 1] += donutdata[i].Duration
                        }
                        donutsecondarynames.push(donutdata[i].Secondaryname)
                        donutsecondarycolours.push("#" + donutdata[i].Colour)
                        donutsecondaryvalues.push(donutdata[i].Duration)
                    }
                    // need to convert to a percentage
                    //donutvalues = toRelative(donutvalues)
                    drawdonut()
                } catch (error) {
                    console.log(error)
                }
            }

            function drawdonut() {
                const ctx = document.getElementById('myChart');
            
                new Chart(ctx, {
                    plugins: [ChartDataLabels],
                    type: 'doughnut',
                    data: {
                        //labels: [donutsecondarynames, {donutprimarynames}],
                        datasets: [{
                            data: donutsecondaryvalues,
                            backgroundColor: donutsecondarycolours,
                            labels: donutsecondarynames
                        },
                        {
                            data: donutprimaryvalues,
                            backgroundColor: donutprimarycolours,
                            labels: donutprimarynames
                        }
                    ]
                    },
                    options: {
                        plugins: {
                            datalabels: {
                                labels: {
                                    title: {
                                        color: 'white',
                                        font: {
                                            weight: 'bold'
                                        }
                                    }
                                },
                                formatter: function(value, context) {
                                    //console.log(value)
                                    console.log(context)
                                    return context.dataset.labels[context.dataIndex];
                                }
                                // label: function(tooltipItem, data) {
                                // var dataset = data.datasets[tooltipItem.datasetIndex];
                                // var index = tooltipItem.index;
                                // return dataset.labels[index] + ': ' + dataset.data[index];
                
                            }
                        }
                    }
                });
            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    </body>
  </html>